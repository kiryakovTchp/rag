# Sprint 1: Acceptance Criteria

## Цель
Реализовать рабочий пайплайн загрузки документов: `/ingest` → загрузка в S3 → парсинг → чанкинг → сохранение в БД.

## Что проверяем

### 1. API Endpoints
- ✅ `POST /ingest` - принимает multipart файлы
- ✅ `GET /ingest/{job_id}` - возвращает статус и прогресс
- ✅ Валидация MIME типов
- ✅ Обработка ошибок

### 2. Парсинг документов
- ✅ **PDF**: PyMuPDF4LLM → элементы с page/bbox
- ✅ **Office**: unstructured → элементы по типам
- ✅ **Plain Text**: ручной парсинг по абзацам
- ✅ **Таблицы**: pdfplumber/camelot → markdown с заголовками

### 3. Чанкинг
- ✅ **Header-aware**: построение header_path (breadcrumbs)
- ✅ **Token-aware**: tiktoken, 350-700 токенов, 15% overlap
- ✅ **Table-aware**: группы 20-60 строк с повтором шапки
- ✅ **Метаданные**: page, token_count, table_meta

### 4. Асинхронная обработка
- ✅ **Celery**: очереди parse/chunk
- ✅ **Прогресс**: 0% → 10% → 50% → 70% → 100%
- ✅ **Статусы**: queued → running → done/error
- ✅ **Логирование**: детальные логи каждого этапа

### 5. Хранилище
- ✅ **S3**: MinIO локально, совместимо с R2
- ✅ **БД**: PostgreSQL + SQLAlchemy 2.0
- ✅ **Модели**: Document, Job, Element, Chunk

## Метрики качества

### Производительность
- **Время обработки**: < 1 секунды для простого PDF
- **Память**: < 100MB на документ
- **Параллельность**: поддержка множественных job'ов

### Качество парсинга
- **Текст**: непрерывность (95%+ слов сохранено)
- **Структура**: заголовки и абзацы правильно выделены
- **Таблицы**: заголовки повторяются в чанках

### Надежность
- **Обработка ошибок**: graceful degradation
- **Валидация**: проверка MIME типов и размеров
- **Логирование**: детальные логи для отладки

## Тестирование

### E2E тесты
```bash
# Полный пайплайн
pytest tests/test_ingest_pipeline.py -v

# Таблицы
pytest tests/test_tables_pdf.py -v
```

### Unit тесты
```bash
# Качество чанкинга
pytest tests/test_chunking_quality.py -v

# Парсинг
pytest tests/test_parsing.py -v
```

### Интеграционные тесты
```bash
# Хранилище
pytest tests/test_storage.py -v

# API
pytest tests/test_integration.py -v
```

## Критерии приемки

### Обязательные
- [ ] Все e2e тесты проходят
- [ ] CI pipeline зеленый
- [ ] Нет mock/stub/placeholder в продакшен коде
- [ ] Документация актуальна

### Желательные
- [ ] Время обработки < 0.5s для простых документов
- [ ] Поддержка всех заявленных форматов
- [ ] Детальное логирование
- [ ] Метрики производительности

## Известные ограничения

### Sprint 1
- Нет эмбеддингов и поиска
- Нет генерации ответов
- Локальная разработка на SQLite
- Базовое извлечение таблиц

### Будущие спринты
- Векторный поиск (Sprint 2)
- Генерация ответов (Sprint 3)
- Web UI (Sprint 4)
- Продакшен деплой (Sprint 5)
