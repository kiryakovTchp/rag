# Engineering Log

## 2025-01-27
- Дата: 2025-01-27
- Что сделано: Создан полный каркас проекта PromoAI RAG mini-SaaS
- Почему так: Нужен был готовый foundation для быстрого старта разработки с соблюдением стандартов
- Как работает: FastAPI с /healthz endpoint, структура роутеров, Celery+Redis каркас, Postgres+pgvector подготовка, R2 storage заглушка
- Эффект/риски: Готовый foundation для разработки, строгие стандарты качества, риски минимальны
- Следующие шаги: Создать PR, настроить CI/CD, реализовать реальную логику RAG

## 2025-01-27 (Sprint 1)
- Дата: 2025-01-27
- Что сделано: Реализован полный пайплайн ingest → parsing → chunking с S3/MinIO хранением, Celery очередями, парсингом документов и чанкингом
- Почему так: Нужен рабочий foundation для обработки документов с асинхронной обработкой и отслеживанием прогресса
- Как работает: POST /ingest загружает файл в S3, создает Document+Job, Celery задачи parse/chunk обрабатывают документ в элементы и чанки
- Эффект/риски: Готовый пайплайн для Sprint 1, placeholder парсеры (реальная логика в следующих спринтах), строгая типизация и линтинг
- Следующие шаги: Реализовать реальные парсеры, добавить эмбеддинги и векторный поиск

## 2025-08-30 (Sprint 1 - Финальная фиксация)
- Дата: 2025-08-30
- Что сделано: Завершен Sprint 1 с полным пайплайном таблиц, фиксацией зависимостей, метриками производительности. Реализован TableParser с pdfplumber/camelot, ChunkingPipeline для таблиц с повторением заголовков, CI с реальными сервисами.
- Почему так: Пользователь выявил критические пробелы в CI, документации и тестировании. Нужно было довести Sprint 1 до продакшен-готовности с реальными метриками.
- Как работает: TableParser извлекает таблицы из PDF (16 таблиц из table.pdf), ChunkingPipeline создает table-chunks с метаданными и повторением заголовков каждые 40 строк. CI запускает uvicorn+celery и проверяет /healthz.
- Эффект/риски: + Sprint 1 готов к продакшену. + Реальные метрики: simple.pdf 0.08s, table.pdf 4.2s. + 47 table-chunks из 63 общих. + Все e2e тесты зеленые. - Время обработки сложных PDF может быть высоким.
- Известные ограничения: Нет эмбеддингов/поиска, базовое извлечение таблиц.
- Следующие шаги: Sprint 2 - эмбеддинги (BAAI/bge-m3), индекс (pgvector), ретрив, API /query

## 2025-08-31 (PostgreSQL Mandate)
- Дата: 2025-08-31
- Что сделано: Полный переход на PostgreSQL+pgvector как единственную БД для dev/CI/prod. Удален SQLite из runtime кода, добавлена миграция pgvector extension, обновлены docker-compose, CI и README.
- Почему так: SQLite не поддерживает pgvector и векторные операции. Нужна стабильная и масштабируемая БД для продакшена с единообразием между окружениями.
- Как работает: db/session.py требует postgresql+psycopg URL, docker-compose поднимает Postgres 16 с healthcheck, CI использует Postgres сервис, alembic миграция создает vector extension и индекс.
- Эффект/риски: + Стабильность и масштабируемость выше. + Полная поддержка pgvector. + CI без сюрпризов. + Профессиональный стек. - Сложнее локальная разработка (нужен Docker). - Миграция данных из SQLite.
- Следующие шаги: Sprint 2 - эмбеддинги и векторный поиск на PostgreSQL

## 2025-08-31 (Sprint 2 - Embeddings & Index)
- Дата: 2025-08-31
- Что сделано: Реализован полный пайплайн эмбеддингов и векторного поиска. BGE-M3 embedder (local + Workers AI), pgvector индекс, hybrid retriever с optional reranking, API /query.
- Почему так: Нужен векторный поиск для RAG системы. BGE-M3 выбран за качество и многоязычность, pgvector за стабильность и бесплатность.
- Как работает: EmbeddingProvider генерирует 1024D векторы, PGVectorIndex хранит в PostgreSQL, HybridRetriever комбинирует dense search + reranking, /query возвращает matches с метаданными.
- Эффект/риски: + Полнофункциональный RAG без LLM. + Высокое качество поиска. + Опциональный reranking. + Готовность к Sprint 3. - Сложность отладки. - Зависимость от Workers AI для reranking.
- Следующие шаги: Sprint 3 - LLM интеграция и генерация ответов

## 2025-01-27 (Sprint 2 - Finalization)
- Дата: 2025-01-27
- Что сделано: S2 finalized: admin off by default, progress fixed, status endpoint unified, pgvector probes, stronger wireup
- Почему так: Нужно было убрать "сказки" и сделать e2e пайплайн стабильно работающим без временных роутов и метрик "для красоты"
- Как работает: Admin router включается только с ADMIN_API_ENABLED=true+TOKEN, реальный progress в embed/index tasks, единый /ingest/document/{id} endpoint, IVFFLAT_PROBES настройка, жёсткие wire-up проверки
- Эффект/риски: + Продакшен-готовый Sprint 2. + Стабильный e2e пайплайн. + Правильные метрики прогресса. + Безопасность админ API. - Сложность отладки без админ роутов.
- Следующие шаги: Sprint 3 - LLM слой с провайдерами, prompt engineering, streaming responses

## 2025-01-27 (Sprint 4 - WebSocket Decoupling)
- Дата: 2025-01-27
- Что сделано: S4-1 WebSocket развязка через Redis Pub/Sub. Создан Event Bus, workers используют publish_event вместо API импортов, WebSocket API подписывается на Redis каналы, реальные e2e тесты.
- Почему так: Workers напрямую импортировали API создавая циклические зависимости. Redis Pub/Sub выбран за простоту, надежность и real-time доставку событий.
- Как работает: services/events/bus.py с publish_event/subscribe_loop, workers публикуют в {tenant_id}.jobs, WebSocket подписывается и ретранслирует клиентам, ping/pong + авто-reconnect.
- Эффект/риски: + Развязка workers и API. + Упрощение тестирования. + Масштабируемость WebSocket. + Real-time статус. - Зависимость от Redis. - Сложность отладки через Redis.
- Следующие шаги: S4-2 - WebSocket клиент, real-time UI, job monitoring dashboard

Шаблон записи:
- Дата:
- Что сделано:
- Почему так:
- Как работает:
- Эффект/риски:
- Следующие шаги:
