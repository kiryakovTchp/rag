# ADR 0003: PostgreSQL Database Mandate

## Статус
Accepted

## Дата
2025-08-31

## Контекст
Проект PromoAI RAG требует векторного поиска через pgvector extension. SQLite не поддерживает pgvector и векторные операции, что ограничивает функциональность системы. Необходимо выбрать единую базу данных для всех окружений (dev/CI/prod).

## Решение
Использовать PostgreSQL 16 + pgvector как единственную базу данных для всех окружений.

### Технические детали
- **Драйвер**: SQLAlchemy + psycopg[binary]
- **База данных**: PostgreSQL 16 с pgvector extension
- **Миграции**: Alembic с автоматическим созданием vector extension
- **CI/CD**: GitHub Actions с PostgreSQL сервисом
- **Локальная разработка**: Docker Compose с PostgreSQL

### Ограничения
- SQLite запрещен в runtime коде
- DATABASE_URL обязан начинаться с `postgresql+psycopg`
- Все тесты должны работать с PostgreSQL

## Альтернативы

### SQLite + заглушки
- **Плюсы**: Простота локальной разработки
- **Минусы**: Нет векторного поиска, разное поведение в dev/prod
- **Решение**: Отклонено - критическая функциональность недоступна

### PostgreSQL только в prod
- **Плюсы**: Простота локальной разработки
- **Минусы**: Разное поведение в dev/prod, сложность отладки
- **Решение**: Отклонено - CI/CD сложности, риск сюрпризов

### Гибридный подход
- **Плюсы**: Гибкость
- **Минусы**: Сложность поддержки, риск ошибок
- **Решение**: Отклонено - нарушение принципа "один стек"

## Последствия

### Положительные
- ✅ Полная поддержка pgvector и векторного поиска
- ✅ Единообразие между dev/CI/prod
- ✅ Стабильность и масштабируемость
- ✅ CI без сюрпризов
- ✅ Профессиональный стек

### Отрицательные
- ❌ Сложнее локальная разработка (нужен Docker)
- ❌ Больше ресурсов для разработки
- ❌ Миграция данных из SQLite (если есть)

### Риски
- **Митигация**: Docker Compose автоматизирует запуск
- **Митигация**: CI проверяет работоспособность
- **Митигация**: Документация обновлена

## Реализация

### Изменения в коде
- `db/session.py`: Принудительная проверка PostgreSQL URL
- `services/index/pgvector.py`: Удалены SQLite заглушки
- Тесты: Обновлены для работы с PostgreSQL

### Инфраструктура
- `docker-compose.yml`: PostgreSQL 16 с healthcheck
- `.github/workflows/ci.yml`: PostgreSQL сервис + alembic upgrade
- `.env.example`: PostgreSQL конфигурация

### Защита от регрессии
- `scripts/check_wireup.sh`: Проверка отсутствия SQLite
- Тесты: `tests/test_db_postgres.py`
- CI: Автоматическая проверка всех компонентов

## Следующие шаги
1. Мониторинг CI/CD pipeline
2. Обновление документации разработчика
3. Рассмотрение оптимизаций производительности
